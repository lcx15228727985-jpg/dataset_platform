import os
import cv2
import numpy as np
import pandas as pd
from tqdm import tqdm

# ==========================================
# é…ç½®
# ==========================================
# ä½¿ç”¨ä¹‹å‰çš„éå¯¹ç§°æ•°æ®é›†
DATA_ROOT = "/root/asym_pinn_dataset"
CSV_PATH = os.path.join(DATA_ROOT, "metadata.csv")
OUTPUT_CSV = "wire_features.csv"


def get_marker_angles(img_gray):
    """
    ä»ç°åº¦å›¾ä¸­æå– 3 ä¸ª Marker çš„è§’åº¦
    è¿”å›: [angle_0, angle_1, angle_2] (å¼§åº¦, -pi åˆ° pi)
    å…¶ä¸­ angle_0 å¯¹åº”æœ€å¤§çš„é‚£ä¸ªç‚¹ (ä¸»çº¿æŸ)
    """
    # 1. äºŒå€¼åŒ–
    _, thresh = cv2.threshold(img_gray, 50, 255, cv2.THRESH_BINARY)

    # 2. æ‰¾è½®å»“
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # è‡³å°‘è¦æ‰¾åˆ° 3 ä¸ªç‚¹
    if len(contours) < 3:
        return None

    # 3. åˆ†æè½®å»“ (æ‰¾åœ†å¿ƒå’Œé¢ç§¯)
    markers = []
    img_center = np.array([img_gray.shape[1] / 2, img_gray.shape[0] / 2])

    for cnt in contours:
        area = cv2.contourArea(cnt)
        (x, y), radius = cv2.minEnclosingCircle(cnt)

        # è®¡ç®—ç›¸å¯¹äºå›¾åƒä¸­å¿ƒçš„è§’åº¦
        # yè½´å‘ä¸‹ï¼Œxè½´å‘å³ã€‚ä½¿ç”¨ arctan2(y, x)
        # æ³¨æ„åæ ‡ç³»è½¬æ¢: y_img = -y_cartesian
        dx = x - img_center[0]
        dy = y - img_center[1]

        # å›¾åƒåæ ‡ç³»è½¬æåæ ‡è§’åº¦ (yå‘ä¸‹, æ‰€ä»¥dyè¦åä¸€ä¸‹æˆ–è€…ç›´æ¥ç”¨)
        # è¿™é‡Œæˆ‘ä»¬ç»Ÿä¸€ç”¨ atan2(dy, dx)ï¼Œåªè¦å‰åä¸€è‡´å³å¯
        angle = np.arctan2(dy, dx)

        markers.append({'area': area, 'angle': angle, 'center': (x, y)})

    # 4. æ’åºï¼šæŒ‰é¢ç§¯ä»å¤§åˆ°å°
    # areaæœ€å¤§çš„å°±æ˜¯ Marker 0 (æˆ‘ä»¬è®¾å®šçš„éå¯¹ç§°ä¸»æ ‡è®°)
    markers.sort(key=lambda x: x['area'], reverse=True)

    # å–å‰3ä¸ª (é˜²æ­¢æœ‰å™ªç‚¹)
    top_3 = markers[:3]

    # æå–è§’åº¦
    # top_3[0] æ˜¯ä¸»æ ‡è®°ï¼Œå¿…é¡»æ”¾åœ¨ç¬¬ä¸€ä¸ªä½ç½®
    # åé¢çš„ä¸¤ä¸ªæŒ‰è§’åº¦æ’åºï¼Œä¿è¯é¡ºåºä¸€è‡´æ€§
    others = sorted(top_3[1:], key=lambda x: x['angle'])

    result_angles = [top_3[0]['angle']] + [m['angle'] for m in others]

    return result_angles


def process_dataset():
    if not os.path.exists(CSV_PATH):
        print("âŒ æ‰¾ä¸åˆ°æ•°æ®é›†")
        return

    df = pd.read_csv(CSV_PATH)
    feature_data = []

    print("ğŸš€ æ­£åœ¨æå–çº¿æŸè§’åº¦ç‰¹å¾...")

    for idx, row in tqdm(df.iterrows(), total=len(df)):
        npy_path = os.path.join(DATA_ROOT, row['filename'])
        try:
            stack = np.load(npy_path)  # (5, 224, 224)

            # å–é¦–å°¾ä¸¤å¸§ (Siamese)
            img_a = stack[0]
            img_b = stack[-1]

            angles_a = get_marker_angles(img_a)
            angles_b = get_marker_angles(img_b)

            if angles_a is None or angles_b is None:
                continue

            # ä¿å­˜ç‰¹å¾
            # è¾“å…¥: 6ä¸ªè§’åº¦ + 1ä¸ªè·ç¦»
            # è¾“å‡º: kappa, phi
            feature_row = {
                'a0': angles_a[0], 'a1': angles_a[1], 'a2': angles_a[2],
                'b0': angles_b[0], 'b1': angles_b[1], 'b2': angles_b[2],
                'delta_dist': 4.0,  # å‡è®¾é—´éš”4å¸§ï¼Œè¿™é‡Œå¯ä»¥ç®€åŒ–ä¸ºå›ºå®šå€¼æˆ–ä»metaè¯»å–
                'kappa': row['kappa'],
                'phi': row['phi']
            }
            feature_data.append(feature_row)

        except Exception as e:
            continue

    # ä¿å­˜ä¸ºæ–°çš„ CSV
    new_df = pd.DataFrame(feature_data)
    new_df.to_csv(OUTPUT_CSV, index=False)
    print(f"âœ… ç‰¹å¾æå–å®Œæ¯•ï¼Œä¿å­˜è‡³: {OUTPUT_CSV}")
    print(f"   æœ‰æ•ˆæ ·æœ¬æ•°: {len(new_df)} / {len(df)}")


if __name__ == "__main__":
    process_dataset()